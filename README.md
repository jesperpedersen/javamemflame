javamemflame will generate a `mem-info-<pid>.txt` file with Java memory allocation information which can be turned into a flame graph.

## Requirements

* Java 11
* Apache Maven
* [http://github.com/brendangregg/FlameGraph](http://github.com/brendangregg/FlameGraph "FlameGraph")

## Build

```sh
mvn clean package
```

## Usage

javamemflame will record memory allocation during the lifetime of the JVM with

```sh
java -javaagent:/path/to/javamemflame.jar ...
```

Then the information can be turned into a flame graph using

```sh
/path/to/FlameGraph/flamegraph.pl --color=java mem-info-<pid>.txt > javamem.svg
```

The result `javamem.svg` can be viewed with any SVG viewer, like Firefox.

## Options

The following agent options are supported.

`delay=<number>`: Delays the recording by the specified number of milliseconds.

`duration=<number>`: Record by the specified number of milliseconds.

Multiple options can be selected using the ',' character, like

```sh
java -javaagent:/path/to/javamemflame.jar=duration=1000,delay=500 ...
```

### Generating meminfo-pid.txt

The `meminfo-pid.txt` is generated by

```sh
java -jar javamemflame.jar javamemflame-pid.jfr
```

Optionally, the memory allocations can be filtered by package using

```sh
java -jar javamemflame.jar javamemflame-pid.jfr package[,package]*
```

## Tricks

The `mem-info-<pid>.txt` file can get quite huge in size, and therefore the resulting flame graph as well.

However, the `mem-info-<pid>.txt` file is in a text format, so standard tools can be used to
find the information needed.

Show the top 10 allocation traces

<pre>
head -10 mem-info-&lt;pid&gt;.txt
</pre>

Filter removed allocations between two runs to ```removed.txt```

<pre>
diff -U 0 mem-info-&lt;pid1&gt;.txt mem-info-&lt;pid2&gt;.txt | grep "\-java" | cut -c 2- > removed.txt
</pre>

Filter added allocations between two runs to ```added.txt```

<pre>
diff -U 0 mem-info-&lt;pid1&gt;.txt mem-info-&lt;pid2&gt;.txt | grep "\+java" | cut -c 2- > added.txt
</pre>


## Thanks to

* [Johannes Rudolph](http://github.com/jrudolph "Johannes Rudolph")
* [Brendan Gregg](http://github.com/brendangregg "Brendan Gregg")

## License

This project is licensed under EPL v2. See the LICENSE file.
